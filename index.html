<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experimento de Igualación a la Muestra</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background-color: #f0f2f5; padding: 20px; color: #1a1a1a; }
        #experiment-container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 800px; margin: auto; min-height: 500px; display: flex; flex-direction: column; }
        h1 { color: #2c3e50; font-size: 24px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .form-group { margin: 20px 0; text-align: left; max-width: 300px; margin-left: auto; margin-right: auto; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        select { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; }
        .consent-box { text-align: left; line-height: 1.5; font-size: 14px; background: #fdfdfd; padding: 25px; border: 1px solid #ddd; border-radius: 8px; overflow-y: auto; max-height: 400px; margin-bottom: 20px; }
        .info-label { font-weight: bold; color: #2c3e50; display: block; margin-top: 10px; text-decoration: underline; }
        .stimulus-sample { font-size: 70px; font-weight: bold; margin: 30px auto; padding: 25px; border: 4px solid #007bff; width: 160px; cursor: pointer; border-radius: 15px; background: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .options-container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 25px; }
        .option-btn { padding: 20px 40px; font-size: 32px; cursor: pointer; border: 2px solid #2c3e50; border-radius: 10px; background: #fff; font-weight: bold; }
        #feedback { font-size: 26px; font-weight: bold; margin-top: 35px; height: 40px; }
        .main-btn { padding: 15px 40px; font-size: 18px; cursor: pointer; background: #28a745; color: white; border: none; border-radius: 6px; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="experiment-container">
    <div id="section-consent">
        <h1>Consentimiento Informado</h1>
        <div class="consent-box">
            <p><strong>Título del Proyecto:</strong> Estudio sobre procesos de discriminación condicional (Igualación a la muestra).</p>
            <p><strong>Investigador(a):</strong> Jorge Hernandez, Itzel Tamayo, Lilian Martin del campo, Amairani Muñoz, Samuel Salazar</p>
            <p><strong>Institución:</strong> Universidad Insurgentes Plantel Sur II</p>
            <span class="info-label">1. Propósito del Estudio</span>
            <p>El objetivo de esta actividad es recolectar datos con fines estrictamente académicos para analizar los procesos de respuesta ante tareas de igualación a la muestra.</p>
            <span class="info-label">2. Procedimiento</span>
            <p>Se le presentará un estímulo "muestra" y varios estímulos de "comparación". Su tarea consistirá en seleccionar el estímulo que corresponde a la muestra.</p>
            <span class="info-label">3. Confidencialidad y Manejo de Datos</span>
            <p>Toda la información recolectada será estrictamente confidencial. Los datos serán anónimos.</p>
            <span class="info-label">4. Riesgos y Beneficios</span>
            <p>No existen riesgos físicos ni psicológicos previstos. Su participación contribuye al aprendizaje académico.</p>
            <span class="info-label">5. Voluntariedad</span>
            <p>Su participación es totalmente voluntaria y puede retirarse en cualquier momento.</p>
            <hr>
            <p><strong>Declaración de Consentimiento:</strong> He leído y comprendido la información anterior. Acepto participar voluntariamente.</p>
            <p>Aceptación: [x] Sí, acepto participar.</p>
            <p><strong>Fecha:</strong> 17/12/2025</p>
        </div>
        <button class="main-btn" onclick="showDataForm()">Siguiente</button>
    </div>

    <div id="section-data" class="hidden">
        <h1>Datos del Participante</h1>
        <div class="form-group">
            <label for="p-edad">Seleccione su Edad:</label>
            <select id="p-edad"></select>
        </div>
        <div class="form-group">
            <label for="p-sexo">Sexo Biológico:</label>
            <select id="p-sexo">
                <option value="Hombre">Masculino</option>
                <option value="Mujer">Femenino</option>
            </select>
        </div>
        <button class="main-btn" onclick="showInstructions()">Confirmar y Continuar</button>
    </div>

    <div id="section-instructions" class="hidden">
        <h1>Instrucciones</h1>
        <p>1. Toque el estímulo del centro.<br>2. Elija la opción de abajo que corresponda.</p>
        <button class="main-btn" style="background:#007bff" onclick="initPhase()">Comenzar</button>
    </div>

    <div id="experiment-area" class="hidden">
        <h2 id="phase-display">Fase 1</h2>
        <div id="sample-area">
            <div class="stimulus-sample" id="sample" onclick="showDeltas()">?</div>
        </div>
        <div id="deltas-area" class="hidden">
            <div class="options-container" id="options"></div>
        </div>
        <div id="feedback"></div>
    </div>

    <div id="section-final" class="hidden">
        <h1>¡Completado!</h1>
        <p>Gracias por participar.</p>
        <div id="admin-panel" class="hidden">
            <button class="main-btn" style="background:#17a2b8" onclick="downloadExcel()">Descargar Excel de Investigador</button>
        </div>
    </div>
</div>

<script>
    const edadSelect = document.getElementById('p-edad');
    for(let i=18; i<=99; i++) {
        let opt = document.createElement('option');
        opt.value = i; opt.innerHTML = i;
        edadSelect.appendChild(opt);
    }

    // Estímulos de investigación (Trigramas CVC)
    const stim = {
        correct: { A: "VEC", B: "GOM", C: "JAL" },
        distractors: { A: ["ZID", "KEP"], B: ["LUT", "VOR"], C: ["NAX", "PIB"] }
    };

    const phases = [
        { id: 0, num: "1", rel: "AB", type: "train", minTrials: 18 },
        { id: 1, num: "2", rel: "BC", type: "train", minTrials: 18 },
        { id: 2, num: "3", rel: "MIX", type: "train", minTrials: 36 },
        { id: 3, num: "4", rel: "BA", type: "test", trials: 12 },
        { id: 4, num: "5", rel: "CB", type: "test", trials: 12 },
        { id: 5, num: "6", rel: "AC", type: "test", trials: 12 },
        { id: 6, num: "7", rel: "CA", type: "test", trials: 12 }
    ];

    let currentPhaseIdx = 0;
    let currentTrial = 0;
    let trialsList = [];
    let recentHits = [];
    let summary = { edad: "", sexo: "", f1_n: 0, f2_n: 0, f3_n: 0, s1_p: 0, s1_c: "No", s2_p: 0, s2_c: "No", e1_p: 0, e1_c: "No", e2_p: 0, e2_c: "No" };

    function showDataForm() {
        document.getElementById('section-consent').classList.add('hidden');
        document.getElementById('section-data').classList.remove('hidden');
    }

    function showInstructions() {
        summary.edad = document.getElementById('p-edad').value;
        summary.sexo = document.getElementById('p-sexo').value;
        document.getElementById('section-data').classList.add('hidden');
        document.getElementById('section-instructions').classList.remove('hidden');
    }

    function initPhase() {
        document.getElementById('section-instructions').classList.add('hidden');
        document.getElementById('experiment-area').classList.remove('hidden');
        const phase = phases[currentPhaseIdx];
        document.getElementById('phase-display').innerText = "Fase " + phase.num;
        currentTrial = 0;
        recentHits = [];
        generateTrial();
        showTrial();
    }

    function generateTrial() {
        const phase = phases[currentPhaseIdx];
        let rel = phase.rel;
        if (rel === "MIX") rel = Math.random() > 0.5 ? "AB" : "BC";
        let sample, correct, options;
        if (rel === "AB") { sample = stim.correct.A; correct = stim.correct.B; options = [stim.correct.B, ...stim.distractors.B]; }
        else if (rel === "BC") { sample = stim.correct.B; correct = stim.correct.C; options = [stim.correct.C, ...stim.distractors.C]; }
        else if (rel === "BA") { sample = stim.correct.B; correct = stim.correct.A; options = [stim.correct.A, ...stim.distractors.A]; }
        else if (rel === "CB") { sample = stim.correct.C; correct = stim.correct.B; options = [stim.correct.B, ...stim.distractors.B]; }
        else if (rel === "AC") { sample = stim.correct.A; correct = stim.correct.C; options = [stim.correct.C, ...stim.distractors.C]; }
        else if (rel === "CA") { sample = stim.correct.C; correct = stim.correct.A; options = [stim.correct.A, ...stim.distractors.A]; }
        trialsList = [{ sample, correct, options: options.sort(() => Math.random() - 0.5) }];
    }

    function showTrial() {
        const trial = trialsList[0];
        document.getElementById('sample').innerText = trial.sample;
        document.getElementById('sample-area').classList.remove('hidden');
        document.getElementById('deltas-area').classList.add('hidden');
        document.getElementById('feedback').innerText = "";
        const optionsDiv = document.getElementById('options');
        optionsDiv.innerHTML = "";
        trial.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = "option-btn";
            btn.innerText = opt;
            btn.onclick = () => checkResponse(opt, trial.correct);
            optionsDiv.appendChild(btn);
        });
    }

    function showDeltas() { document.getElementById('deltas-area').classList.remove('hidden'); }

    function checkResponse(selected, correct) {
        const phase = phases[currentPhaseIdx];
        const isCorrect = selected === correct;
        currentTrial++;
        
        if (phase.type === "train") {
            recentHits.push(isCorrect ? 1 : 0);
            document.getElementById('feedback').innerText = isCorrect ? "¡CORRECTO!" : "INCORRECTO";
            document.getElementById('feedback').style.color = isCorrect ? "#28a745" : "#dc3545";
            let hitsCount = recentHits.slice(-18).reduce((a, b) => a + b, 0);
            if (currentTrial >= phase.minTrials && hitsCount >= 15) {
                setTimeout(() => finishPhase(), 600);
            } else if (currentTrial >= 54) {
                setTimeout(() => finishPhase(), 600);
            } else {
                setTimeout(() => { generateTrial(); showTrial(); }, 600);
            }
        } else {
            recentHits.push(isCorrect ? 1 : 0);
            if (currentTrial >= phase.trials) {
                finishPhase();
            } else {
                generateTrial(); showTrial();
            }
        }
    }

   function finishPhase() {
        const phase = phases[currentPhaseIdx];
        if (phase.id === 0) summary.f1_n = currentTrial;
        if (phase.id === 1) summary.f2_n = currentTrial;
        if (phase.id === 2) summary.f3_n = currentTrial;
        
        if (phase.type === "test") {
            let p = Math.round((recentHits.reduce((a, b) => a + b, 0) / phase.trials) * 100);
            let c = p >= 84 ? "Cumple" : "No Cumple";
            if (phase.id === 3) { summary.s1_p = p; summary.s1_c = c; }
            if (phase.id === 4) { summary.s2_p = p; summary.s2_c = c; }
            if (phase.id === 5) { summary.e1_p = p; summary.e1_c = c; }
            if (phase.id === 6) { summary.e2_p = p; summary.e2_c = c; }
        }

        currentPhaseIdx++;
        if (currentPhaseIdx < phases.length) {
            alert("Fase finalizada. Siguiente fase...");
            initPhase();
        } else {
            document.getElementById('experiment-area').classList.add('hidden');
            document.getElementById('section-final').classList.remove('hidden');
            // AQUÍ SE DISPARA EL ENVÍO AUTOMÁTICO
            enviarADrive();
        }
    }

    function enviarADrive() {
        // REEMPLAZA ESTA URL CON LA TUYA DE GOOGLE APPS SCRIPT
        const URL_WEB_APP = "TU_URL_DE_GOOGLE_APPS_SCRIPT_AQUI";

        const formData = new URLSearchParams();
        formData.append("edad", summary.edad);
        formData.append("sexo", summary.sexo);
        formData.append("f1_n", summary.f1_n);
        formData.append("f2_n", summary.f2_n);
        formData.append("f3_n", summary.f3_n);
        formData.append("s1_p", summary.s1_p);
        formData.append("s1_c", summary.s1_c);
        formData.append("s2_p", summary.s2_p);
        formData.append("s2_c", summary.s2_c);
        formData.append("e1_p", summary.e1_p);
        formData.append("e1_c", summary.e1_c);
        formData.append("e2_p", summary.e2_p);
        formData.append("e2_c", summary.e2_c);

        fetch(URL_WEB_APP, {
            method: "POST",
            body: formData,
            mode: "no-cors" 
        })
        .then(() => console.log("Datos enviados al Excel"))
        .catch(err => console.error("Error de red:", err));
    }

    document.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 'd') document.getElementById('admin-panel').classList.remove('hidden');
    });

    function downloadExcel() {
        let csv = "data:text/csv;charset=utf-8,";
        csv += "Participante,Edad,Sexo,Fase A-B,Fase B-C,Fase Mixta,Simetria 1 %,Criterio S1,Simetria 2 %,Criterio S2,Equivalencia 1 %,Criterio E1,Equivalencia 2 %,Criterio E2\n";
        csv += `Sujeto,${summary.edad},${summary.sexo},${summary.f1_n},${summary.f2_n},${summary.f3_n},${summary.s1_p},${summary.s1_c},${summary.s2_p},${summary.s2_c},${summary.e1_p},${summary.e1_c},${summary.e2_p},${summary.e2_c}\n`;
        const encodedUri = encodeURI(csv);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "Resultados_Sujeto.csv");
        document.body.appendChild(link);
        link.click();
    }
</script>
